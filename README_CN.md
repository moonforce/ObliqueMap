# ObliqueMap - 倾斜摄影模型自动贴图软件

基于 Unity2018.3.1f1 实现，OpenCV插件需自行购买，对接Smart3D格式的相机内外参xml文件。

## 简明操作步骤
1. 新建工程
2. 添加图片文件夹
3. 添加模型文件
4. 添加Smart3D数据
5. 设置偏移参数
6. 贴图
   * ​**自动贴图**：点击自动贴图
   * ​**手动贴图**：设置点大小和线粗细，参照下文进行操作
7. 保存工程，工程中保存了图片路径、模型路径、相机参数、偏移量、点大小、线粗细

https://github.com/user-attachments/assets/9f3b726d-0b7c-4e7b-9661-b3149e39b849

## 目录
- [ObliqueMap - 倾斜摄影模型自动贴图软件](#obliquemap---倾斜摄影模型自动贴图软件)
  - [简明操作步骤](#简明操作步骤)
  - [目录](#目录)
- [1. 文件](#1-文件)
  - [1.1 新建工程](#11-新建工程)
  - [1.2 打开工程](#12-打开工程)
  - [1.3 关闭工程](#13-关闭工程)
  - [1.4 保存工程](#14-保存工程)
  - [1.5 工程另存为](#15-工程另存为)
  - [1.6 添加](#16-添加)
    - [1.6.1 添加航拍影像](#161-添加航拍影像)
    - [1.6.2 添加三维模型](#162-添加三维模型)
    - [1.6.3 添加地景模型](#163-添加地景模型)
    - [1.6.4 增加Smart3D空三数据](#164-增加smart3d空三数据)
  - [1.7 退出](#17-退出)
- [2. 工具](#2-工具)
  - [2.1 设置](#21-设置)
    - [2.1.1 PhotoShop路径](#211-photoshop路径)
    - [2.1.2 XY坐标偏移](#212-xy坐标偏移)
    - [2.1.3 点直径](#213-点直径)
    - [2.1.4 线宽](#214-线宽)
  - [2.2 清除无关纹理](#22-清除无关纹理)
  - [2.3 释放无用内存](#23-释放无用内存)
  - [2.4 清空相机参数](#24-清空相机参数)
  - [2.5 自动贴图](#25-自动贴图)
- [3. 帮助](#3-帮助)
  - [3.1 帮助文档](#31-帮助文档)
- [4. 软件操作](#4-软件操作)
  - [4.1 工程管理树状图](#41-工程管理树状图)
  - [4.2 影像窗口](#42-影像窗口)
    - [4.2.1 浏览操作](#421-浏览操作)
    - [4.2.2 UV调整操作](#422-uv调整操作)
    - [4.2.3 右键菜单及对应快捷键操作](#423-右键菜单及对应快捷键操作)
      - [4.2.3.1 开始编辑（E）](#4231-开始编辑e)
      - [4.2.3.2 贴图（T）](#4232-贴图t)
      - [4.2.3.3 查看全图](#4233-查看全图)
      - [4.2.3.4 下张影像（空格）](#4234-下张影像空格)
      - [4.2.3.5 取消编辑（C）](#4235-取消编辑c)
  - [4.3 模型窗口](#43-模型窗口)
    - [4.3.1 浏览操作](#431-浏览操作)
    - [4.3.2 右键菜单及对应快捷键操作](#432-右键菜单及对应快捷键操作)
      - [4.3.2.1 开始编辑（E）](#4321-开始编辑e)
      - [4.3.2.2 在PS中打开（F）](#4322-在ps中打开f)
      - [4.3.2.3 刷新纹理（R）](#4323-刷新纹理r)
      - [4.3.2.4 清除纹理（D）](#4324-清除纹理d)
      - [4.3.2.5 模型复位（R）](#4325-模型复位r)
      - [4.3.2.6 输出模型（S）](#4326-输出模型s)
      - [4.3.2.7 取消编辑（C）](#4327-取消编辑c)
  - [4.4 影像筛选窗口](#44-影像筛选窗口)

# 1. 文件

工程文件后缀名为 `omp`（即Oblique Map Project），`omp`为XML格式文件，文件中保存的信息包括：影像路径、模型路径、地景路径、相机信息和设置面板中的信息。

## 1.1 新建工程

创建 `omp`工程，工程名显示在菜单栏中间，如果工程信息发生变化，则工程名后会加 `*`提示。

## 1.2 打开工程

打开 `omp`工程，有进度条提示加载进度。

## 1.3 关闭工程

关闭当前工程。

## 1.4 保存工程

保存当前工程。

## 1.5 工程另存为

另存当前工程为另一 `omp`文件。

## 1.6 添加

### 1.6.1 添加航拍影像

添加航拍影像夹至工程，此操作会将该文件夹下所有 `jpg`影像添加至工程，但注意不会添加子文件夹下的影像。加载影像时会判断子文件夹 `thumb`中是否存在对应影像的缩略图，若不存在则创建，注意创建缩略图的过程较慢，但只要不清除 `thumb`文件夹中的缩略图，则加载相同影像时无需再次创建缩略图。创建缩略图的目的是提高影像筛选窗口的加载速度。

需要注意的是在添加影像前应将所有影像转换为同名 `r5g6b5`格式的 `dds`文件，并放在同一目录下（原 `jpg`文件也保留），使用 `dds`的目的是提高原始影像的加载速度。

### 1.6.2 添加三维模型

添加三维模型，可以在对话框中单选或多选三维模型文件，既可以添加白模，也可以添加贴图作业过程中保存的三维模型。加载模型时会判断子文件夹 `CompleteUvModel`中是否存在对应模型的UV完整的 `obj`文件，若不存在则创建。创建UV完整的 `obj`文件是为了补充原始白模中不完整的UV列表，只要不清除 `CompleteUvModel`文件夹中的 `obj`文件，则加载相同模型时无需再次创建UV完整的 `obj`文件。

### 1.6.3 添加地景模型

添加 `obj`格式的地景模型，注意 `obj`格式具有正确路径的材质和纹理图片路径。

### 1.6.4 增加Smart3D空三数据

本软件目前能够处理的空三数据是Smart3D格式的相机内外参 `xml`文件。

## 1.7 退出

退出软件。

# 2. 工具

## 2.1 设置

### 2.1.1 PhotoShop路径

设置本机PhotoShop路径，用于编辑拾取出的纹理。可通过右侧设置按钮选定PhotoShop的 `exe`路径，也可将 `exe`路径直接复制到输入框中，注意路径应精确至 `exe`文件名，如 `C:\Program Files\Adobe\Adobe Photoshop CC 2018\Photoshop.exe`。

### 2.1.2 XY坐标偏移

通常，贴图作业前应将白模顶点坐标统一增加一个偏移量，使其移动到小坐标处。此处XY坐标偏移应填写这个偏移量，在软件内部计算过程中会在相机外参的位置信息上累加这个偏移。如 `x偏移=-490000`，`y偏移=-3800000`。

### 2.1.3 点直径

此处用于设置影像窗口中UV点的直径。

### 2.1.4 线宽

此处用于设置影像窗口中UV线的宽度。

## 2.2 清除无关纹理

在作业过程中，随着UV的不断手动调整，每次贴图操作都会在 `obj`文件同级目录中产生一张 `jpg`图片，但模型每个面实际使用的是最后一次贴图产生的图片，所以此按钮可清除不再使用的 `jpg`图片，即只保留材质文件中使用到的 `jpg`图片。

## 2.3 释放无用内存

软件运行过程中，加载卸载影像和模型过程中会进行内存回收，但是难免产生内存垃圾，所以此按钮可在内存占用过多时，手动释放内存。

## 2.4 清空相机参数

清空相机内外参。

## 2.5 自动贴图

该功能暂未实现。

# 3. 帮助

## 3.1 帮助文档

打开此文档。

# 4. 软件操作

软件画面分区如下图所示，分区之间的分割线可拖拽，用以改变分区大小。
![UserInterface](https://github.com/moonforce/ObliqueMap/blob/master/UserInterface_CN.jpg)

## 4.1 工程管理树状图

工程管理树状图用来管理工程中的航拍影像、三维模型和地景模型。右键点击各个根节点，可进行清空和添加操作；右键点击各个叶节点可进行删除对应条目的操作；选中多个叶节点后按 `Delete`键可实现多个条目的同时删除。双击航拍影像中某一影像，可在影像窗口中浏览该影像；双击三维模型中某一模型，可在模型窗口浏览该模型。

## 4.2 影像窗口

### 4.2.1 浏览操作

鼠标中键缩放，鼠标中键按住实现拖拽。

### 4.2.2 UV调整操作

鼠标移动至UV点上，左键按住实现UV点拖拽；鼠标移动至UV线上，左键按住实现UV线拖拽；鼠标在UV框范围内并且不在点线上时，左键按住实现UV整体移动。

### 4.2.3 右键菜单及对应快捷键操作

#### 4.2.3.1 开始编辑（E）

在模型窗口中显示模型时激活这一选项，单击此按钮进入编辑状态，进入编辑状态后执行选中面在每张影像中的投影算法，此时影像筛选窗口中的影像按照投影方向进行最优排序，并且自动选中影像筛选窗口中的第一张影像至影像窗口，UV点线也同时显示在影像上。

#### 4.2.3.2 贴图（T）

进入编辑状态后，单击此按钮将UV框选中区域贴至模型选中面上，此时将在模型同级目录生成一张对应区域的 `jpg`图片。

#### 4.2.3.3 查看全图

单击此按钮可将影像由局部可见恢复至全图可见的浏览状态。

#### 4.2.3.4 下张影像（空格）

进入编辑状态后，单击此按钮，可将影像窗口中的影像切换到影像筛选窗口中的下一张影像。

#### 4.2.3.5 取消编辑（C）

单击此按钮退出编辑状态。

## 4.3 模型窗口

### 4.3.1 浏览操作

鼠标中键缩放，鼠标左键按住实现旋转，鼠标中键按住实现拖拽。

### 4.3.2 右键菜单及对应快捷键操作

#### 4.3.2.1 开始编辑（E）

在模型窗口中显示模型时激活这一选项，单击此按钮进入编辑状态，进入编辑状态后执行选中面在每张影像中的投影算法，此时影像筛选窗口中的影像按照投影方向进行最优排序，并且自动选中影像筛选窗口中的第一张影像至影像窗口，UV点线也同时显示在影像上。

#### 4.3.2.2 在PS中打开（F）

进入编辑状态并贴图后，单击此按钮可在PhotoShop中打开这张局部 `jpg`图片。

#### 4.3.2.3 刷新纹理（R）

进入编辑状态后，单击此按钮可刷新选中面的纹理，通常用于PS结束。

#### 4.3.2.4 清除纹理（D）

进入编辑状态后，单击此按钮可清除选中面的纹理，使得选中面处于未贴图的白面状态，当注意此时模型目录中的 `jpg`图片并不清除掉。

#### 4.3.2.5 模型复位（R）

单击此按钮可将模型复位到模型窗口中间。

#### 4.3.2.6 输出模型（S）

进入编辑状态后，单击此按钮，可输出模型并更新 `mtl`材质文件，此操作会直接覆盖原 `obj`模型，应注意做好备份工作。

#### 4.3.2.7 取消编辑（C）

单击此按钮退出编辑状态。

## 4.4 影像筛选窗口

进入编辑状态后，可左右拖拽此窗口选择用于贴图的影像，双击其中的某一影像将其送至影像窗口。
